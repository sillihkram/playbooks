---
- name: Configure and Run ReaR Backup to NFS Share
  hosts: all
  become: true

  vars:
    nfs_server_ip: "192.168.1.22"
    nfs_export_path: "/nfs/Public/ReaR"
    
    # ReaR uses the hostname to create a subdirectory in the BACKUP_URL automatically.
    rear_local_conf_template: |
      # ReaR Configuration for NFS Backup (Generated by Ansible)
      
      # Output Method: Create a bootable ISO rescue image
      OUTPUT=ISO
      
      # Output URL: Where to store the ISO image (NFS share)
      # ReaR will automatically store the ISO in nfs://SERVER/PATH/{{ ansible_hostname }}
      OUTPUT_URL=nfs://{{ nfs_server_ip }}{{ nfs_export_path }}
      
      # Backup Method: Use ReaR's internal backup (tar archive)
      BACKUP=NETFS
      
      # Backup URL: Location for the full system backup archive (backup.tar.gz)
      # ReaR will automatically store the archive in nfs://SERVER/PATH/{{ ansible_hostname }}
      BACKUP_URL=nfs://{{ nfs_server_ip }}{{ nfs_export_path }}
      
      # Set NFS options for reliable mounting
      BACKUP_OPTIONS="nfsvers=3,nolock"
      OUTPUT_OPTIONS="nfsvers=3,nolock"
      
      # Exclude common non-critical mount points
      BACKUP_PROG_EXCLUDE=( "${BACKUP_PROG_EXCLUDE[@]}" '/mnt' '/media' '/proc' '/sys' '/tmp' '/dev/shm' '/var/tmp' )

  tasks:
    - name: Ensure required packages are installed (for RedHat-based systems)
      ansible.builtin.package:
        name: 
          - rear
          - genisoimage
          - nfs-utils
        state: present
      when: ansible_os_family == "RedHat"
      
    - name: Ensure required packages are installed (for Debian-based systems)
      ansible.builtin.package:
        name: 
          - rear
          - extlinux
          - nfs-common
        state: present
      when: ansible_os_family == "Debian"
      
    - name: Create /etc/rear directory if it does not exist
      ansible.builtin.file:
        path: /etc/rear
        state: directory
        mode: '0755'
        
    - name: Configure /etc/rear/local.conf
      ansible.builtin.copy:
        content: "{{ rear_local_conf_template }}"
        dest: /etc/rear/local.conf
        mode: '0644'
        
    - name: Perform the ReaR mkbackup (creates ISO and data backup)
      ansible.builtin.command:
        cmd: rear -v mkbackup
        # Note: This is a long-running command. Default timeout may need adjustment.
      args:
        # Check for presence of rear to ensure the command is executed correctly
        creates: "/var/lib/rear/output/rear-{{ ansible_hostname }}.iso"
